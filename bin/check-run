#!/usr/bin/env bash
set -euo pipefail

ENV_FILE="/opt/restic/config/restic.env"
RESTIC_BIN="/opt/restic/bin/restic"

# shellcheck disable=SC1090
source "$ENV_FILE"

export RESTIC_PASSWORD_FILE="${RESTIC_PASSWORD_FILE:-/opt/restic/config/password}"
export RESTIC_REPOSITORY="${RESTIC_REPOSITORY:?Set RESTIC_REPOSITORY in $ENV_FILE}"
for v in AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_S3_BUCKET_LOOKUP RESTIC_CACHE_DIR AWS_DEFAULT_REGION; do
  [ -n "${!v-}" ] && export "$v"
done
export AWS_DEFAULT_REGION="${AWS_DEFAULT_REGION:-us-east-1}"

exec "$RESTIC_BIN" -r "$RESTIC_REPOSITORY" check --read-data-subset="${CHECK_READ_SUBSET:-1/50}" \
  --password-file "$RESTIC_PASSWORD_FILE" \
  --cache-dir "${RESTIC_CACHE_DIR:-/var/cache/restic}"
