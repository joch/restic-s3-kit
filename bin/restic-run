#!/usr/bin/env bash
set -euo pipefail

ENV_FILE="/opt/restic/config/restic.env"
PATHS_FILE="/opt/restic/config/paths.list"
RESTIC_BIN="/opt/restic/bin/restic"

# Load config
# shellcheck disable=SC1090
source "$ENV_FILE"

# Export what the child process needs
export RESTIC_PASSWORD_FILE="${RESTIC_PASSWORD_FILE:-/opt/restic/config/password}"
export RESTIC_REPOSITORY="${RESTIC_REPOSITORY:?Set RESTIC_REPOSITORY in $ENV_FILE}"
# Pass-through common S3 vars (only if set)
for v in AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_S3_BUCKET_LOOKUP RESTIC_CACHE_DIR AWS_DEFAULT_REGION; do
  [ -n "${!v-}" ] && export "$v"
done
# Safe default region for S3-compatible endpoints
export AWS_DEFAULT_REGION="${AWS_DEFAULT_REGION:-us-east-1}"

HOST_ARG=()
[ -n "${HOSTNAME_OVERRIDE:-}" ] && HOST_ARG=(--host "$HOSTNAME_OVERRIDE")

TAG_ARGS=()
if [ -n "${TAGS:-}" ]; then
  for t in $TAGS; do TAG_ARGS+=("--tag" "$t"); done
fi

exec "$RESTIC_BIN" -r "$RESTIC_REPOSITORY" backup \
  "${HOST_ARG[@]}" \
  "${TAG_ARGS[@]}" \
  --password-file "$RESTIC_PASSWORD_FILE" \
  --cache-dir "${RESTIC_CACHE_DIR:-/var/cache/restic}" \
  --one-file-system \
  --exclude-if-present .nobackup \
  --exclude-file "${EXCLUDES_FILE:-/opt/restic/config/excludes.list}" \
  --files-from "$PATHS_FILE" \
  ${EXTRA_BACKUP_ARGS:-}
